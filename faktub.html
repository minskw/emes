<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faktubuu - Pencatat Hutang</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/8774/8774909.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            padding-bottom: 80px; /* Space for bottom nav */
        }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            z-index: 50;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .nav-item.active {
            color: #3b82f6;
        }
        .nav-item.active .nav-icon {
            background: #dbeafe;
        }
        .sync-status {
            position: fixed;
            top: 70px;
            right: 16px;
            z-index: 30;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sync-online { background: #dcfce7; color: #166534; }
        .sync-offline { background: #fef2f2; color: #991b1b; }
        .sync-syncing { background: #fef3c7; color: #92400e; }
        @media print {
            .no-print { display: none !important; }
            body { padding-bottom: 0; }
            .bottom-nav { display: none; }
            .sync-status { display: none; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Sync Status Indicator -->
    <div id="syncStatus" class="sync-status sync-offline no-print">
        <i class="fas fa-cloud"></i>
        <span>Connecting...</span>
    </div>

    <!-- Header -->
    <div class="gradient-bg text-white py-4 px-4 sticky top-0 z-40">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="https://cdn-icons-png.flaticon.com/128/8774/8774909.png" alt="Faktubuu" class="w-8 h-8">
                <div>
                    <h1 class="text-lg font-bold">Faktubuu Cloud</h1>
                    <p class="text-blue-100 text-sm">Pencatat Hutang Online</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-xs text-blue-100">Total Hutang</div>
                <div id="totalDebt" class="text-lg font-bold">Rp 0</div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="px-4 py-4">
        <!-- Home Tab -->
        <div id="home-tab" class="tab-content active">
            <!-- Quick Stats -->
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="bg-white rounded-lg card-shadow p-3 text-center">
                    <div class="text-blue-500 text-lg mb-1"><i class="fas fa-clipboard-list"></i></div>
                    <div class="text-lg font-bold text-gray-800" id="totalDebts">0</div>
                    <div class="text-xs text-gray-600">Total</div>
                </div>
                <div class="bg-white rounded-lg card-shadow p-3 text-center">
                    <div class="text-red-500 text-lg mb-1"><i class="fas fa-times-circle"></i></div>
                    <div class="text-lg font-bold text-red-600" id="unpaidDebts">0</div>
                    <div class="text-xs text-gray-600">Belum Lunas</div>
                </div>
                <div class="bg-white rounded-lg card-shadow p-3 text-center">
                    <div class="text-green-500 text-lg mb-1"><i class="fas fa-check-circle"></i></div>
                    <div class="text-lg font-bold text-green-600" id="paidDebts">0</div>
                    <div class="text-xs text-gray-600">Lunas</div>
                </div>
            </div>

            <!-- Search -->
            <div class="bg-white rounded-lg card-shadow p-3 mb-4">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput" 
                           class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm"
                           placeholder="Cari nama pemberi hutang...">
                </div>
            </div>

            <!-- Debt List -->
            <div id="debtList" class="space-y-3">
                <div class="bg-white rounded-lg card-shadow p-6 text-center text-gray-500">
                    <div class="text-3xl mb-2 text-gray-400"><i class="fas fa-database"></i></div>
                    <p class="text-sm">Memuat data...</p>
                    <p class="text-xs text-gray-400 mt-2">Aplikasi siap digunakan dalam mode offline</p>
                </div>
            </div>
        </div>

        <!-- Add Tab -->
        <div id="add-tab" class="tab-content">
            <div class="bg-white rounded-lg card-shadow p-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-plus-circle text-blue-500 text-xl mr-2"></i>
                    Tambah Hutang Baru
                </h2>
                
                <form id="debtForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pemberi Hutang</label>
                        <input type="text" id="creditorName" required list="creditorsList"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                               placeholder="Contoh: Budi, Toko Sari">
                        <datalist id="creditorsList"></datalist>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Hutang</label>
                        <input type="number" id="debtAmount" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                               placeholder="500000">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Hutang</label>
                            <input type="date" id="debtDate" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jatuh Tempo</label>
                            <input type="date" id="dueDate" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan (Opsional)</label>
                        <textarea id="debtDescription" rows="2" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                  placeholder="Keperluan hutang..."></textarea>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Simpan Hutang
                    </button>
                </form>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <div class="space-y-4">
                <!-- Summary Cards -->
                <div class="bg-white rounded-lg card-shadow p-4">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                        Ringkasan Hutang
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Total Hutang Aktif:</span>
                            <span class="font-bold text-red-600" id="reportUnpaidAmount">Rp 0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Total Sudah Dibayar:</span>
                            <span class="font-bold text-green-600" id="reportPaidAmount">Rp 0</span>
                        </div>
                        <div class="flex justify-between items-center border-t pt-2">
                            <span class="text-gray-800 font-medium">Total Keseluruhan:</span>
                            <span class="font-bold text-blue-600" id="reportTotalAmount">Rp 0</span>
                        </div>
                    </div>
                </div>

                <!-- Laporan Per Pemberi Hutang -->
                <div class="bg-white rounded-lg card-shadow p-4">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-users text-green-500 mr-2"></i>
                        Laporan Per Pemberi Hutang
                    </h3>
                    <div id="creditorReports" class="space-y-3">
                        <p class="text-gray-500 text-sm">Belum ada data</p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button onclick="printReport()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center">
                        <i class="fas fa-print mr-2"></i>Cetak Laporan Lengkap
                    </button>
                    <button onclick="shareToWhatsApp()" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center">
                        <i class="fab fa-whatsapp mr-2"></i>Share ke WhatsApp
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="space-y-4">
                <!-- Cloud Status -->
                <div class="bg-white rounded-lg card-shadow p-4">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-cloud text-blue-500 mr-2"></i>
                        Status Cloud Sync
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">Auto Sync</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="autoSync" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="text-xs text-gray-500">
                            Status: <span id="syncStatusText">Menghubungkan...</span><br>
                            Terakhir sync: <span id="lastSyncTime">Belum pernah</span><br>
                            <span id="connectionDetails" class="text-xs text-gray-400"></span>
                        </div>
                        <div class="space-y-2">
                            <button onclick="syncNow()" 
                                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg text-sm">
                                <i class="fas fa-sync mr-2"></i>Sinkronisasi Sekarang
                            </button>
                            <button onclick="reconnectToCloud()" id="reconnectBtn"
                                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-lg text-sm hidden">
                                <i class="fas fa-wifi mr-2"></i>Coba Hubungkan Ulang
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="bg-white rounded-lg card-shadow p-4">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-database text-blue-500 mr-2"></i>
                        Kelola Data
                    </h3>
                    <div class="space-y-3">
                        <button onclick="exportData()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg text-sm">
                            <i class="fas fa-file-csv mr-2"></i>Export Data CSV
                        </button>
                        <button onclick="clearAllData()" 
                                class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg text-sm">
                            <i class="fas fa-trash-alt mr-2"></i>Hapus Semua Data
                        </button>
                    </div>
                </div>

                <!-- App Info -->
                <div class="bg-white rounded-lg card-shadow p-4">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-info-circle text-purple-500 mr-2"></i>
                        Informasi Aplikasi
                    </h3>
                    <div class="space-y-2 text-sm text-gray-600">
                        <p><strong>Versi:</strong> 4.0 Cloud Ready</p>
                        <p><strong>Total Data:</strong> <span id="settingsTotalDebts">0</span> hutang</p>
                        <p><strong>Storage:</strong> Google Sheets Cloud</p>
                        <p class="text-xs text-gray-500 mt-3">
                            Data tersimpan otomatis di Google Sheets dan tersinkronisasi real-time.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav no-print">
        <div class="flex">
            <button onclick="switchTab('home')" class="nav-item active flex-1 py-3 px-2 text-center">
                <div class="nav-icon w-8 h-8 mx-auto rounded-lg bg-blue-100 flex items-center justify-center mb-1">
                    <i class="fas fa-home"></i>
                </div>
                <div class="text-xs">Beranda</div>
            </button>
            <button onclick="switchTab('add')" class="nav-item flex-1 py-3 px-2 text-center text-gray-600">
                <div class="nav-icon w-8 h-8 mx-auto rounded-lg flex items-center justify-center mb-1">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="text-xs">Tambah</div>
            </button>
            <button onclick="switchTab('reports')" class="nav-item flex-1 py-3 px-2 text-center text-gray-600">
                <div class="nav-icon w-8 h-8 mx-auto rounded-lg flex items-center justify-center mb-1">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="text-xs">Laporan</div>
            </button>
            <button onclick="switchTab('settings')" class="nav-item flex-1 py-3 px-2 text-center text-gray-600">
                <div class="nav-icon w-8 h-8 mx-auto rounded-lg flex items-center justify-center mb-1">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="text-xs">Pengaturan</div>
            </button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 no-print">
        <div class="bg-white rounded-xl max-w-sm w-full max-h-screen overflow-y-auto">
            <div class="sticky top-0 bg-white p-4 border-b border-gray-200 rounded-t-xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Edit Hutang</h3>
                    <button type="button" onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <form id="editForm" class="p-4">
                <input type="hidden" id="editId">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Pemberi Hutang</label>
                        <input type="text" id="editCreditorName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Hutang</label>
                        <input type="number" id="editDebtAmount" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Hutang</label>
                            <input type="date" id="editDebtDate" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jatuh Tempo</label>
                            <input type="date" id="editDueDate" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <textarea id="editDebtDescription" rows="2" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="closeEditModal()" 
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm">
                        Batal
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Database Model
        let creditors = JSON.parse(localStorage.getItem('creditors')) || [];
        let debts = JSON.parse(localStorage.getItem('debts')) || [];
        let nextCreditorId = parseInt(localStorage.getItem('nextCreditorId')) || 1;
        let nextDebtId = parseInt(localStorage.getItem('nextDebtId')) || 1;
        let currentTab = 'home';

        // Google Apps Script Configuration - Built-in
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbytF-j9hvm4x8YM44J_R2_r7Fa4OZcXgJw0eJO9nfUc1XYSkBbeJtuiMRte-4wE_W50Ng/exec';
        
        let sheetsConfig = JSON.parse(localStorage.getItem('sheetsConfig')) || {
            url: GOOGLE_APPS_SCRIPT_URL,
            isConnected: false,
            lastSync: null,
            autoSync: false, // Default to false to avoid CORS issues
            offlineMode: true
        };

        // Sync status
        let syncStatus = 'connecting'; // connecting, online, offline, syncing
        let syncInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('debtDate').value = today;
            
            // Set auto sync checkbox based on saved config
            document.getElementById('autoSync').checked = sheetsConfig.autoSync;
            
            // Initialize cloud connection
            initializeCloudConnection();
            
            updateCreditorsList();
            renderDebts();
            updateStatistics();
            updateReports();
            updateSyncStatus('connecting');
            
            // Event listeners
            document.getElementById('debtForm').addEventListener('submit', addDebt);
            document.getElementById('editForm').addEventListener('submit', updateDebt);
            document.getElementById('searchInput').addEventListener('input', filterDebts);
            document.getElementById('autoSync').addEventListener('change', toggleAutoSync);
        });

        // Check Internet Connection
        async function checkInternetConnection() {
            try {
                const response = await fetch('https://www.google.com/favicon.ico', {
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                return true;
            } catch (error) {
                return false;
            }
        }

        // Initialize Cloud Connection with CORS-friendly approach
        async function initializeCloudConnection() {
            try {
                updateSyncStatus('connecting');
                
                // First check internet connection
                const hasInternet = await checkInternetConnection();
                if (!hasInternet) {
                    throw new Error('Tidak ada koneksi internet');
                }
                
                // Test connection using JSONP to avoid CORS issues
                return new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        reject(new Error('Koneksi timeout'));
                    }, 10000);
                    
                    const callbackName = 'test_callback_' + Date.now();
                    const script = document.createElement('script');
                    
                    window[callbackName] = function(result) {
                        clearTimeout(timeoutId);
                        document.head.removeChild(script);
                        delete window[callbackName];
                        
                        if (result && result.success) {
                            sheetsConfig.isConnected = true;
                            updateSyncStatus('online');
                            
                            // Load data from cloud
                            downloadFromCloud().then(() => {
                                // Start auto sync if enabled
                                if (sheetsConfig.autoSync) {
                                    startAutoSync();
                                }
                                showSweetAlert('Terhubung!', 'Faktubuu berhasil terhubung ke Google Sheets!', 'success');
                                resolve();
                            }).catch(downloadError => {
                                console.warn('Failed to download initial data:', downloadError);
                                // Continue with local data if download fails
                                renderDebts();
                                updateStatistics();
                                updateReports();
                                showSweetAlert('Terhubung!', 'Faktubuu terhubung ke Google Sheets! Menggunakan data lokal.', 'info');
                                resolve();
                            });
                        } else {
                            reject(new Error('Server response error'));
                        }
                    };
                    
                    script.onerror = function() {
                        clearTimeout(timeoutId);
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Network error'));
                    };
                    
                    script.src = `${GOOGLE_APPS_SCRIPT_URL}?action=test&callback=${callbackName}`;
                    document.head.appendChild(script);
                });
                
            } catch (error) {
                console.error('Connection failed:', error);
                sheetsConfig.isConnected = false;
                updateSyncStatus('offline');
                
                // Show appropriate error message
                let errorMessage = 'Gagal terhubung ke Google Sheets. ';
                if (error.message.includes('timeout')) {
                    errorMessage += 'Koneksi timeout.';
                } else if (error.message.includes('internet')) {
                    errorMessage += 'Periksa koneksi internet Anda.';
                } else {
                    errorMessage += 'Masalah jaringan.';
                }
                
                showSweetAlert('Mode Offline', errorMessage + ' Aplikasi akan berjalan dalam mode offline.', 'warning');
                
                // Load from local storage as fallback
                renderDebts();
                updateStatistics();
                updateReports();
            } finally {
                localStorage.setItem('sheetsConfig', JSON.stringify(sheetsConfig));
                updateSyncStatusText();
            }
        }

        // Cloud Sync Functions with CORS-friendly approach
        async function uploadToCloud(retryCount = 0) {
            const maxRetries = 3;
            
            try {
                const payload = {
                    action: 'sync_upload',
                    debts: debts
                };
                
                // Use JSONP approach for better CORS compatibility
                return new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        reject(new Error('Koneksi timeout - Periksa koneksi internet Anda'));
                    }, 15000);
                    
                    // Create form for POST request to avoid CORS preflight
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = GOOGLE_APPS_SCRIPT_URL;
                    form.target = 'upload_frame_' + Date.now();
                    form.style.display = 'none';
                    
                    // Create hidden iframe for response
                    const iframe = document.createElement('iframe');
                    iframe.name = form.target;
                    iframe.style.display = 'none';
                    
                    // Add data as form field
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'data';
                    input.value = JSON.stringify(payload);
                    form.appendChild(input);
                    
                    // Handle response
                    iframe.onload = function() {
                        clearTimeout(timeoutId);
                        try {
                            const response = iframe.contentDocument || iframe.contentWindow.document;
                            const result = JSON.parse(response.body.textContent);
                            
                            if (result.success) {
                                resolve(result);
                            } else {
                                reject(new Error(result.message || 'Upload failed'));
                            }
                        } catch (error) {
                            // Assume success if we can't parse response (common with Google Apps Script)
                            resolve({ success: true, message: 'Upload completed' });
                        } finally {
                            document.body.removeChild(form);
                            document.body.removeChild(iframe);
                        }
                    };
                    
                    iframe.onerror = function() {
                        clearTimeout(timeoutId);
                        document.body.removeChild(form);
                        document.body.removeChild(iframe);
                        reject(new Error('Upload failed - Network error'));
                    };
                    
                    document.body.appendChild(iframe);
                    document.body.appendChild(form);
                    form.submit();
                });
                
            } catch (error) {
                console.error(`Upload attempt ${retryCount + 1} failed:`, error);
                
                if (retryCount < maxRetries) {
                    // Wait before retry (exponential backoff)
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return uploadToCloud(retryCount + 1);
                }
                
                // Final error after all retries
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    throw new Error('Masalah koneksi ke Google Sheets - Coba lagi nanti');
                } else {
                    throw new Error('Upload gagal: ' + error.message);
                }
            }
        }

        async function downloadFromCloud(retryCount = 0) {
            const maxRetries = 3;
            
            try {
                // Use JSONP for GET requests to avoid CORS issues
                return new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        reject(new Error('Koneksi timeout - Periksa koneksi internet Anda'));
                    }, 15000);
                    
                    const callbackName = 'jsonp_callback_' + Date.now();
                    const script = document.createElement('script');
                    
                    // Set up global callback
                    window[callbackName] = function(result) {
                        clearTimeout(timeoutId);
                        document.head.removeChild(script);
                        delete window[callbackName];
                        
                        if (result.success) {
                            // Update local data with cloud data
                            if (result.data && result.data.debts) {
                                debts = result.data.debts;
                                
                                // Rebuild creditors from debts
                                creditors = [];
                                const creditorNames = new Set();
                                let maxCreditorId = 0;
                                let maxDebtId = 0;
                                
                                debts.forEach(debt => {
                                    if (debt.id > maxDebtId) maxDebtId = debt.id;
                                    
                                    if (!creditorNames.has(debt.creditorName)) {
                                        creditorNames.add(debt.creditorName);
                                        const creditorId = creditors.length + 1;
                                        creditors.push({
                                            id: creditorId,
                                            name: debt.creditorName,
                                            createdAt: debt.createdAt || new Date().toISOString()
                                        });
                                        debt.creditorId = creditorId;
                                        if (creditorId > maxCreditorId) maxCreditorId = creditorId;
                                    } else {
                                        const creditor = creditors.find(c => c.name === debt.creditorName);
                                        if (creditor) {
                                            debt.creditorId = creditor.id;
                                        }
                                    }
                                });
                                
                                nextCreditorId = maxCreditorId + 1;
                                nextDebtId = maxDebtId + 1;
                                
                                saveToStorage();
                                updateCreditorsList();
                            }
                            resolve(result);
                        } else {
                            reject(new Error(result.message || 'Download failed'));
                        }
                    };
                    
                    script.onerror = function() {
                        clearTimeout(timeoutId);
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Download failed - Network error'));
                    };
                    
                    script.src = `${GOOGLE_APPS_SCRIPT_URL}?action=download&callback=${callbackName}`;
                    document.head.appendChild(script);
                });
                
            } catch (error) {
                console.error(`Download attempt ${retryCount + 1} failed:`, error);
                
                if (retryCount < maxRetries) {
                    // Wait before retry (exponential backoff)
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return downloadFromCloud(retryCount + 1);
                }
                
                // Final error after all retries
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    throw new Error('Masalah koneksi ke Google Sheets - Coba lagi nanti');
                } else {
                    throw new Error('Download gagal: ' + error.message);
                }
            }
        }

        async function syncNow() {
            if (!sheetsConfig.isConnected) {
                showSweetAlert('Error', 'Tidak terhubung ke Google Sheets!', 'error');
                return;
            }
            
            updateSyncStatus('syncing');
            
            try {
                // Upload local data to cloud
                await uploadToCloud();
                
                // Download latest data from cloud
                await downloadFromCloud();
                
                sheetsConfig.lastSync = new Date().toISOString();
                localStorage.setItem('sheetsConfig', JSON.stringify(sheetsConfig));
                
                updateSyncStatus('online');
                renderDebts();
                updateStatistics();
                updateReports();
                
                showSweetAlert('Berhasil!', 'Data berhasil disinkronisasi dengan Google Sheets!', 'success');
                
            } catch (error) {
                updateSyncStatus('offline');
                showSweetAlert('Error', 'Sinkronisasi gagal: ' + error.message, 'error');
            }
        }

        function toggleAutoSync() {
            sheetsConfig.autoSync = document.getElementById('autoSync').checked;
            localStorage.setItem('sheetsConfig', JSON.stringify(sheetsConfig));
            
            if (sheetsConfig.autoSync && sheetsConfig.isConnected) {
                startAutoSync();
            } else {
                stopAutoSync();
            }
            
            updateSyncStatusText();
        }

        function startAutoSync() {
            if (syncInterval) return;
            
            syncInterval = setInterval(async () => {
                if (sheetsConfig.isConnected && sheetsConfig.autoSync) {
                    try {
                        await syncNow();
                    } catch (error) {
                        console.error('Auto sync failed:', error);
                    }
                }
            }, 300000); // Sync every 5 minutes
        }

        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        function updateSyncStatus(status) {
            syncStatus = status;
            const statusElement = document.getElementById('syncStatus');
            
            statusElement.className = 'sync-status no-print';
            
            switch (status) {
                case 'online':
                    statusElement.classList.add('sync-online');
                    statusElement.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Online</span>';
                    break;
                case 'syncing':
                    statusElement.classList.add('sync-syncing');
                    statusElement.innerHTML = '<i class="fas fa-sync fa-spin"></i><span>Syncing...</span>';
                    break;
                case 'connecting':
                    statusElement.classList.add('sync-syncing');
                    statusElement.innerHTML = '<i class="fas fa-plug"></i><span>Connecting...</span>';
                    break;
                default:
                    statusElement.classList.add('sync-offline');
                    statusElement.innerHTML = '<i class="fas fa-cloud-slash"></i><span>Offline</span>';
            }
            
            updateSyncStatusText();
        }

        // Reconnect to Cloud
        async function reconnectToCloud() {
            const reconnectBtn = document.getElementById('reconnectBtn');
            reconnectBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menghubungkan...';
            reconnectBtn.disabled = true;
            
            try {
                await initializeCloudConnection();
            } catch (error) {
                console.error('Reconnect failed:', error);
            } finally {
                reconnectBtn.innerHTML = '<i class="fas fa-wifi mr-2"></i>Coba Hubungkan Ulang';
                reconnectBtn.disabled = false;
            }
        }

        function updateSyncStatusText() {
            const statusText = document.getElementById('syncStatusText');
            const lastSyncText = document.getElementById('lastSyncTime');
            const connectionDetails = document.getElementById('connectionDetails');
            const reconnectBtn = document.getElementById('reconnectBtn');
            
            if (sheetsConfig.isConnected) {
                statusText.textContent = sheetsConfig.autoSync ? 'Terhubung (Auto Sync)' : 'Terhubung (Manual)';
                statusText.className = 'text-green-600 font-medium';
                connectionDetails.textContent = 'Google Sheets tersinkronisasi';
                reconnectBtn.classList.add('hidden');
            } else {
                statusText.textContent = 'Tidak terhubung';
                statusText.className = 'text-red-600 font-medium';
                connectionDetails.textContent = 'Mode offline - Data tersimpan lokal';
                reconnectBtn.classList.remove('hidden');
            }
            
            if (sheetsConfig.lastSync) {
                const lastSync = new Date(sheetsConfig.lastSync);
                lastSyncText.textContent = lastSync.toLocaleString('id-ID');
            } else {
                lastSyncText.textContent = 'Belum pernah';
            }
        }

        // Enhanced notification system with SweetAlert
        function showSweetAlert(title, text, icon) {
            Swal.fire({
                title: title,
                text: text,
                icon: icon,
                confirmButtonText: 'OK',
                confirmButtonColor: '#3b82f6'
            });
        }

        // Tab Navigation
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            currentTab = tabName;
            
            // Update data when switching to reports
            if (tabName === 'reports') {
                updateReports();
            }
            if (tabName === 'settings') {
                document.getElementById('settingsTotalDebts').textContent = debts.length;
                updateSyncStatusText();
            }
        }

        async function addDebt(e) {
            e.preventDefault();
            
            const creditorName = document.getElementById('creditorName').value.trim();
            
            // Find or create creditor
            let creditor = creditors.find(c => c.name.toLowerCase() === creditorName.toLowerCase());
            if (!creditor) {
                creditor = {
                    id: nextCreditorId++,
                    name: creditorName,
                    createdAt: new Date().toISOString()
                };
                creditors.push(creditor);
            }
            
            const debt = {
                id: nextDebtId++,
                creditorId: creditor.id,
                creditorName: creditor.name,
                amount: parseFloat(document.getElementById('debtAmount').value),
                debtDate: document.getElementById('debtDate').value,
                dueDate: document.getElementById('dueDate').value,
                description: document.getElementById('debtDescription').value,
                status: 'unpaid',
                createdAt: new Date().toISOString()
            };
            
            debts.push(debt);
            saveToStorage();
            updateCreditorsList();
            
            // Reset form
            document.getElementById('debtForm').reset();
            document.getElementById('debtDate').value = new Date().toISOString().split('T')[0];
            
            renderDebts();
            updateStatistics();
            showSweetAlert('Berhasil', 'Hutang berhasil ditambahkan!', 'success');
            
            // Auto sync if enabled
            if (sheetsConfig.autoSync && sheetsConfig.isConnected) {
                setTimeout(() => syncNow(), 1000);
            }
            
            // Switch to home tab
            switchTab('home');
        }

        function renderDebts() {
            const container = document.getElementById('debtList');
            
            if (debts.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg card-shadow p-6 text-center text-gray-500">
                        <div class="text-3xl mb-2 text-gray-400"><i class="fas fa-clipboard-list"></i></div>
                        <p class="text-sm">Belum ada hutang yang dicatat</p>
                        <p class="text-xs text-gray-400 mt-2">Data tersinkronisasi dengan Google Sheets</p>
                    </div>
                `;
                return;
            }
            
            // Group debts by creditor
            const groupedDebts = {};
            debts.forEach(debt => {
                const creditor = creditors.find(c => c.id === debt.creditorId) || { name: debt.creditorName || 'Unknown' };
                const creditorName = creditor.name;
                
                if (!groupedDebts[creditorName]) {
                    groupedDebts[creditorName] = {
                        creditor: creditor,
                        debts: [],
                        totalAmount: 0,
                        unpaidAmount: 0,
                        totalDebts: 0,
                        unpaidDebts: 0
                    };
                }
                
                groupedDebts[creditorName].debts.push(debt);
                groupedDebts[creditorName].totalAmount += debt.amount;
                groupedDebts[creditorName].totalDebts++;
                
                if (debt.status === 'unpaid') {
                    groupedDebts[creditorName].unpaidAmount += debt.amount;
                    groupedDebts[creditorName].unpaidDebts++;
                }
            });
            
            container.innerHTML = Object.keys(groupedDebts).map(creditorName => {
                const group = groupedDebts[creditorName];
                const hasUnpaid = group.unpaidDebts > 0;
                
                return `
                    <div class="bg-white rounded-lg card-shadow mb-3">
                        <!-- Creditor Header -->
                        <div class="p-4 cursor-pointer" onclick="toggleCreditorDetails('${creditorName}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="text-xl text-blue-500"><i class="fas fa-user"></i></div>
                                    <div>
                                        <h3 class="font-bold text-gray-800">${creditorName}</h3>
                                        <div class="text-xs text-gray-600">
                                            ${group.totalDebts} hutang • ${group.unpaidDebts} belum lunas
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold ${hasUnpaid ? 'text-red-600' : 'text-green-600'}">
                                        Rp ${group.unpaidAmount.toLocaleString('id-ID')}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        <span id="toggle-${creditorName}" class="inline-block transform transition-transform">▼</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Debt Details -->
                        <div id="details-${creditorName}" class="hidden border-t border-gray-100">
                            ${group.debts.map(debt => {
                                const isOverdue = debt.dueDate && new Date(debt.dueDate) < new Date() && debt.status === 'unpaid';
                                
                                return `
                                    <div class="p-4 border-b border-gray-50 last:border-b-0">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-2 mb-2">
                                                    <span class="px-2 py-1 text-xs rounded-full ${debt.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                        <i class="fas ${debt.status === 'paid' ? 'fa-check' : 'fa-times'}"></i>
                                                    </span>
                                                    ${isOverdue ? '<span class="px-2 py-1 text-xs rounded-full bg-red-200 text-red-900"><i class="fas fa-exclamation-triangle"></i></span>' : ''}
                                                </div>
                                                
                                                <div class="font-bold text-blue-600 mb-1">
                                                    Rp ${debt.amount.toLocaleString('id-ID')}
                                                </div>
                                                
                                                <div class="text-xs text-gray-600 mb-2">
                                                    ${formatDate(debt.debtDate)}
                                                    ${debt.dueDate ? ` • Tempo: ${formatDate(debt.dueDate)}` : ''}
                                                </div>
                                                
                                                ${debt.description ? `<p class="text-xs text-gray-600">${debt.description}</p>` : ''}
                                            </div>
                                            
                                            <div class="flex flex-col space-y-1 ml-3">
                                                <button onclick="toggleStatus(${debt.id})" 
                                                        class="px-2 py-1 rounded text-xs font-medium ${debt.status === 'paid' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                                    <i class="fas ${debt.status === 'paid' ? 'fa-undo' : 'fa-check'}"></i>
                                                </button>
                                                <button onclick="editDebt(${debt.id})" 
                                                        class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteDebt(${debt.id})" 
                                                        class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <button onclick="shareCreditorToWhatsApp('${creditorName}')" 
                                                        class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">
                                                    <i class="fab fa-whatsapp"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleCreditorDetails(creditorName) {
            const details = document.getElementById(`details-${creditorName}`);
            const toggle = document.getElementById(`toggle-${creditorName}`);
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                toggle.style.transform = 'rotate(180deg)';
            } else {
                details.classList.add('hidden');
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        async function toggleStatus(id) {
            const debt = debts.find(d => d.id === id);
            if (debt) {
                debt.status = debt.status === 'paid' ? 'unpaid' : 'paid';
                debt.paidDate = debt.status === 'paid' ? new Date().toISOString() : null;
                saveToStorage();
                renderDebts();
                updateStatistics();
                updateReports();
                
                showSweetAlert('Berhasil', `Hutang ${debt.status === 'paid' ? 'ditandai lunas' : 'ditandai belum lunas'}!`, 'success');
                
                // Auto sync if enabled
                if (sheetsConfig.autoSync && sheetsConfig.isConnected) {
                    setTimeout(() => syncNow(), 1000);
                }
            }
        }

        function editDebt(id) {
            const debt = debts.find(d => d.id === id);
            if (debt) {
                document.getElementById('editId').value = debt.id;
                document.getElementById('editCreditorName').value = debt.creditorName;
                document.getElementById('editDebtAmount').value = debt.amount;
                document.getElementById('editDebtDate').value = debt.debtDate;
                document.getElementById('editDueDate').value = debt.dueDate || '';
                document.getElementById('editDebtDescription').value = debt.description || '';
                document.getElementById('editModal').classList.remove('hidden');
            }
        }

        async function updateDebt(e) {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('editId').value);
            const debt = debts.find(d => d.id === id);
            
            if (debt) {
                const creditorName = document.getElementById('editCreditorName').value.trim();
                
                // Find or create creditor
                let creditor = creditors.find(c => c.name.toLowerCase() === creditorName.toLowerCase());
                if (!creditor) {
                    creditor = {
                        id: nextCreditorId++,
                        name: creditorName,
                        createdAt: new Date().toISOString()
                    };
                    creditors.push(creditor);
                }
                
                debt.creditorId = creditor.id;
                debt.creditorName = creditor.name;
                debt.amount = parseFloat(document.getElementById('editDebtAmount').value);
                debt.debtDate = document.getElementById('editDebtDate').value;
                debt.dueDate = document.getElementById('editDueDate').value;
                debt.description = document.getElementById('editDebtDescription').value;
                
                saveToStorage();
                updateCreditorsList();
                renderDebts();
                updateStatistics();
                updateReports();
                closeEditModal();
                
                showSweetAlert('Berhasil', 'Hutang berhasil diperbarui!', 'success');
                
                // Auto sync if enabled
                if (sheetsConfig.autoSync && sheetsConfig.isConnected) {
                    setTimeout(() => syncNow(), 1000);
                }
            }
        }

        function deleteDebt(id) {
            Swal.fire({
                title: 'Hapus Hutang?',
                text: 'Apakah Anda yakin ingin menghapus hutang ini?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    debts = debts.filter(d => d.id !== id);
                    saveToStorage();
                    renderDebts();
                    updateStatistics();
                    updateReports();
                    
                    showSweetAlert('Berhasil', 'Hutang berhasil dihapus!', 'success');
                    
                    // Auto sync if enabled
                    if (sheetsConfig.autoSync && sheetsConfig.isConnected) {
                        setTimeout(() => syncNow(), 1000);
                    }
                }
            });
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function filterDebts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredDebts = debts;
            
            if (searchTerm) {
                filteredDebts = filteredDebts.filter(debt => 
                    debt.creditorName.toLowerCase().includes(searchTerm) ||
                    debt.description.toLowerCase().includes(searchTerm)
                );
            }
            
            // Temporarily replace debts array for rendering
            const originalDebts = debts;
            debts = filteredDebts;
            renderDebts();
            debts = originalDebts;
        }

        function updateStatistics() {
            const totalDebts = debts.length;
            const unpaidDebts = debts.filter(d => d.status === 'unpaid').length;
            const paidDebts = debts.filter(d => d.status === 'paid').length;
            const totalAmount = debts.filter(d => d.status === 'unpaid').reduce((sum, debt) => sum + debt.amount, 0);
            
            document.getElementById('totalDebts').textContent = totalDebts;
            document.getElementById('unpaidDebts').textContent = unpaidDebts;
            document.getElementById('paidDebts').textContent = paidDebts;
            document.getElementById('totalDebt').textContent = `Rp ${totalAmount.toLocaleString('id-ID')}`;
        }

        function updateReports() {
            const unpaidAmount = debts.filter(d => d.status === 'unpaid').reduce((sum, debt) => sum + debt.amount, 0);
            const paidAmount = debts.filter(d => d.status === 'paid').reduce((sum, debt) => sum + debt.amount, 0);
            const totalAmount = unpaidAmount + paidAmount;
            
            document.getElementById('reportUnpaidAmount').textContent = `Rp ${unpaidAmount.toLocaleString('id-ID')}`;
            document.getElementById('reportPaidAmount').textContent = `Rp ${paidAmount.toLocaleString('id-ID')}`;
            document.getElementById('reportTotalAmount').textContent = `Rp ${totalAmount.toLocaleString('id-ID')}`;
            
            // Generate creditor reports
            const creditorStats = {};
            debts.forEach(debt => {
                const creditorName = debt.creditorName;
                if (!creditorStats[creditorName]) {
                    creditorStats[creditorName] = {
                        totalAmount: 0,
                        unpaidAmount: 0,
                        paidAmount: 0,
                        totalDebts: 0,
                        unpaidDebts: 0,
                        paidDebts: 0,
                        debts: []
                    };
                }
                
                creditorStats[creditorName].totalAmount += debt.amount;
                creditorStats[creditorName].totalDebts++;
                creditorStats[creditorName].debts.push(debt);
                
                if (debt.status === 'unpaid') {
                    creditorStats[creditorName].unpaidAmount += debt.amount;
                    creditorStats[creditorName].unpaidDebts++;
                } else {
                    creditorStats[creditorName].paidAmount += debt.amount;
                    creditorStats[creditorName].paidDebts++;
                }
            });
            
            const creditorReportsContainer = document.getElementById('creditorReports');
            if (Object.keys(creditorStats).length === 0) {
                creditorReportsContainer.innerHTML = '<p class="text-gray-500 text-sm">Belum ada data</p>';
            } else {
                creditorReportsContainer.innerHTML = Object.entries(creditorStats)
                    .sort(([,a], [,b]) => b.unpaidAmount - a.unpaidAmount)
                    .map(([creditorName, stats]) => `
                        <div class="border border-gray-200 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-user text-lg mr-2"></i>
                                    ${creditorName}
                                </h4>
                                <div class="flex space-x-2">
                                    <button onclick="printCreditorReport('${creditorName}')" 
                                            class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                                        <i class="fas fa-print"></i>
                                    </button>
                                    <button onclick="shareCreditorToWhatsApp('${creditorName}')" 
                                            class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 text-xs">
                                <div class="bg-red-50 p-2 rounded">
                                    <div class="text-red-800 font-medium">Belum Lunas</div>
                                    <div class="text-red-600 font-bold">Rp ${stats.unpaidAmount.toLocaleString('id-ID')}</div>
                                    <div class="text-red-500">${stats.unpaidDebts} hutang</div>
                                </div>
                                <div class="bg-green-50 p-2 rounded">
                                    <div class="text-green-800 font-medium">Sudah Lunas</div>
                                    <div class="text-green-600 font-bold">Rp ${stats.paidAmount.toLocaleString('id-ID')}</div>
                                    <div class="text-green-500">${stats.paidDebts} hutang</div>
                                </div>
                            </div>
                            
                            <div class="mt-2 pt-2 border-t border-gray-100">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-gray-600">Total Keseluruhan:</span>
                                    <span class="font-bold text-blue-600">Rp ${stats.totalAmount.toLocaleString('id-ID')} (${stats.totalDebts} hutang)</span>
                                </div>
                                <div class="flex justify-between items-center text-xs mt-1">
                                    <span class="text-gray-600">Persentase Lunas:</span>
                                    <span class="font-medium ${stats.paidAmount === stats.totalAmount ? 'text-green-600' : 'text-yellow-600'}">
                                        ${stats.totalAmount > 0 ? Math.round((stats.paidAmount / stats.totalAmount) * 100) : 0}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('');
            }
        }

        function printReport() {
            const printWindow = window.open('', '_blank');
            const unpaidDebts = debts.filter(d => d.status === 'unpaid');
            const paidDebts = debts.filter(d => d.status === 'paid');
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Hutang - Faktubuu Cloud</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { margin-bottom: 30px; }
                        .debt-group { margin-bottom: 20px; }
                        .debt-item { margin-left: 20px; margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .unpaid { color: #dc2626; }
                        .paid { color: #16a34a; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>☁️ Laporan Hutang - Faktubuu Cloud</h1>
                        <p>Tanggal: ${new Date().toLocaleDateString('id-ID')}</p>
                        <p><small>Data tersinkronisasi dengan Google Sheets</small></p>
                    </div>
                    
                    <div class="summary">
                        <h2>Ringkasan</h2>
                        <p><strong>Total Hutang Aktif:</strong> <span class="unpaid">Rp ${unpaidDebts.reduce((sum, debt) => sum + debt.amount, 0).toLocaleString('id-ID')}</span></p>
                        <p><strong>Total Sudah Dibayar:</strong> <span class="paid">Rp ${paidDebts.reduce((sum, debt) => sum + debt.amount, 0).toLocaleString('id-ID')}</span></p>
                        <p><strong>Jumlah Hutang Aktif:</strong> ${unpaidDebts.length}</p>
                        <p><strong>Jumlah Hutang Lunas:</strong> ${paidDebts.length}</p>
                    </div>
                    
                    <h2>Detail Hutang Belum Lunas</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Pemberi Hutang</th>
                                <th>Jumlah</th>
                                <th>Tanggal Hutang</th>
                                <th>Jatuh Tempo</th>
                                <th>Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${unpaidDebts.map(debt => `
                                <tr>
                                    <td>${debt.creditorName}</td>
                                    <td class="unpaid">Rp ${debt.amount.toLocaleString('id-ID')}</td>
                                    <td>${formatDate(debt.debtDate)}</td>
                                    <td>${debt.dueDate ? formatDate(debt.dueDate) : '-'}</td>
                                    <td>${debt.description || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h2>Detail Hutang Lunas</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Pemberi Hutang</th>
                                <th>Jumlah</th>
                                <th>Tanggal Hutang</th>
                                <th>Tanggal Lunas</th>
                                <th>Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${paidDebts.map(debt => `
                                <tr>
                                    <td>${debt.creditorName}</td>
                                    <td class="paid">Rp ${debt.amount.toLocaleString('id-ID')}</td>
                                    <td>${formatDate(debt.debtDate)}</td>
                                    <td>${debt.paidDate ? formatDate(debt.paidDate.split('T')[0]) : '-'}</td>
                                    <td>${debt.description || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 40px; text-align: center; color: #666; font-size: 12px;">
                        <p>Dibuat dengan Faktubuu Cloud - Data tersinkronisasi dengan Google Sheets</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function printCreditorReport(creditorName) {
            const creditorDebts = debts.filter(d => d.creditorName === creditorName);
            const unpaidDebts = creditorDebts.filter(d => d.status === 'unpaid');
            const paidDebts = creditorDebts.filter(d => d.status === 'paid');
            
            const totalAmount = creditorDebts.reduce((sum, debt) => sum + debt.amount, 0);
            const unpaidAmount = unpaidDebts.reduce((sum, debt) => sum + debt.amount, 0);
            const paidAmount = paidDebts.reduce((sum, debt) => sum + debt.amount, 0);
            
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Hutang - ${creditorName} - Faktubuu Cloud</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .creditor-info { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                        .summary { margin-bottom: 30px; }
                        .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0; }
                        .summary-card { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .unpaid { color: #dc2626; font-weight: bold; }
                        .paid { color: #16a34a; font-weight: bold; }
                        .total-row { background-color: #f8f9fa; font-weight: bold; }
                        .overdue { background-color: #fef2f2; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>☁️ Laporan Hutang Individu - Faktubuu Cloud</h1>
                        <h2>👤 ${creditorName}</h2>
                        <p>Tanggal Cetak: ${new Date().toLocaleDateString('id-ID', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</p>
                        <p><small>Data tersinkronisasi dengan Google Sheets</small></p>
                    </div>
                    
                    <div class="creditor-info">
                        <h3>📊 Ringkasan Hutang</h3>
                        <div class="summary-grid">
                            <div class="summary-card">
                                <h4>Total Keseluruhan</h4>
                                <div style="font-size: 24px; color: #2563eb;">Rp ${totalAmount.toLocaleString('id-ID')}</div>
                                <div>${creditorDebts.length} transaksi</div>
                            </div>
                            <div class="summary-card">
                                <h4>Belum Lunas</h4>
                                <div style="font-size: 24px;" class="unpaid">Rp ${unpaidAmount.toLocaleString('id-ID')}</div>
                                <div>${unpaidDebts.length} transaksi</div>
                            </div>
                            <div class="summary-card">
                                <h4>Sudah Lunas</h4>
                                <div style="font-size: 24px;" class="paid">Rp ${paidAmount.toLocaleString('id-ID')}</div>
                                <div>${paidDebts.length} transaksi</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <strong>Persentase Pelunasan: ${totalAmount > 0 ? Math.round((paidAmount / totalAmount) * 100) : 0}%</strong>
                        </div>
                    </div>
                    
                    ${unpaidDebts.length > 0 ? `
                    <h3>❌ Hutang Belum Lunas (${unpaidDebts.length})</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Jumlah</th>
                                <th>Tanggal Hutang</th>
                                <th>Jatuh Tempo</th>
                                <th>Status Tempo</th>
                                <th>Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${unpaidDebts.map((debt, index) => {
                                const isOverdue = debt.dueDate && new Date(debt.dueDate) < new Date();
                                const daysUntilDue = debt.dueDate ? Math.ceil((new Date(debt.dueDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                                return `
                                <tr ${isOverdue ? 'class="overdue"' : ''}>
                                    <td>${index + 1}</td>
                                    <td class="unpaid">Rp ${debt.amount.toLocaleString('id-ID')}</td>
                                    <td>${formatDate(debt.debtDate)}</td>
                                    <td>${debt.dueDate ? formatDate(debt.dueDate) : '-'}</td>
                                    <td>
                                        ${debt.dueDate ? 
                                            (isOverdue ? 
                                                `<span style="color: #dc2626;">⚠️ Terlambat ${Math.abs(daysUntilDue)} hari</span>` : 
                                                `<span style="color: #059669;">✅ ${daysUntilDue} hari lagi</span>`
                                            ) : '-'
                                        }
                                    </td>
                                    <td>${debt.description || '-'}</td>
                                </tr>
                            `}).join('')}
                            <tr class="total-row">
                                <td colspan="5"><strong>Total Belum Lunas:</strong></td>
                                <td><strong class="unpaid">Rp ${unpaidAmount.toLocaleString('id-ID')}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    ` : '<p><em>✅ Tidak ada hutang yang belum lunas</em></p>'}
                    
                    ${paidDebts.length > 0 ? `
                    <h3>✅ Hutang Sudah Lunas (${paidDebts.length})</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Jumlah</th>
                                <th>Tanggal Hutang</th>
                                <th>Tanggal Lunas</th>
                                <th>Durasi</th>
                                <th>Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${paidDebts.map((debt, index) => {
                                const daysToPay = debt.paidDate ? Math.ceil((new Date(debt.paidDate) - new Date(debt.debtDate)) / (1000 * 60 * 60 * 24)) : 0;
                                return `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td class="paid">Rp ${debt.amount.toLocaleString('id-ID')}</td>
                                    <td>${formatDate(debt.debtDate)}</td>
                                    <td>${debt.paidDate ? formatDate(debt.paidDate.split('T')[0]) : '-'}</td>
                                    <td>${daysToPay > 0 ? daysToPay + ' hari' : '-'}</td>
                                    <td>${debt.description || '-'}</td>
                                </tr>
                            `}).join('')}
                            <tr class="total-row">
                                <td colspan="5"><strong>Total Sudah Lunas:</strong></td>
                                <td><strong class="paid">Rp ${paidAmount.toLocaleString('id-ID')}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    ` : '<p><em>Belum ada hutang yang lunas</em></p>'}
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 12px;">
                        <p>Laporan ini dibuat secara otomatis oleh Faktubuu Cloud</p>
                        <p>Data tersinkronisasi dengan Google Sheets • Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function shareToWhatsApp() {
            const unpaidDebts = debts.filter(d => d.status === 'unpaid');
            const totalUnpaid = unpaidDebts.reduce((sum, debt) => sum + debt.amount, 0);
            
            let message = `☁️ *LAPORAN HUTANG - FAKTUBUU CLOUD*\n`;
            message += `Tanggal: ${new Date().toLocaleDateString('id-ID')}\n\n`;
            message += `💰 *RINGKASAN*\n`;
            message += `• Total Hutang Aktif: Rp ${totalUnpaid.toLocaleString('id-ID')}\n`;
            message += `• Jumlah Hutang: ${unpaidDebts.length}\n\n`;
            
            if (unpaidDebts.length > 0) {
                message += `❌ *HUTANG BELUM LUNAS:*\n`;
                unpaidDebts.forEach((debt, index) => {
                    message += `${index + 1}. ${debt.creditorName}\n`;
                    message += `   Rp ${debt.amount.toLocaleString('id-ID')}\n`;
                    message += `   ${formatDate(debt.debtDate)}`;
                    if (debt.dueDate) {
                        message += ` (Tempo: ${formatDate(debt.dueDate)})`;
                    }
                    message += `\n\n`;
                });
            }
            
            message += `☁️ Dibuat dengan Faktubuu Cloud - Data tersinkronisasi dengan Google Sheets`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        function shareCreditorToWhatsApp(creditorName) {
            const creditorDebts = debts.filter(d => d.creditorName === creditorName && d.status === 'unpaid');
            const totalAmount = creditorDebts.reduce((sum, debt) => sum + debt.amount, 0);
            
            let message = `☁️ *HUTANG KEPADA ${creditorName.toUpperCase()}*\n\n`;
            message += `💰 Total: Rp ${totalAmount.toLocaleString('id-ID')}\n`;
            message += `📊 Jumlah: ${creditorDebts.length} hutang\n\n`;
            
            message += `📝 *DETAIL:*\n`;
            creditorDebts.forEach((debt, index) => {
                message += `${index + 1}. Rp ${debt.amount.toLocaleString('id-ID')}\n`;
                message += `   ${formatDate(debt.debtDate)}`;
                if (debt.dueDate) {
                    message += ` (Tempo: ${formatDate(debt.dueDate)})`;
                }
                if (debt.description) {
                    message += `\n   ${debt.description}`;
                }
                message += `\n\n`;
            });
            
            message += `☁️ Dibuat dengan Faktubuu Cloud - Data tersinkronisasi dengan Google Sheets`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Nama Pemberi Hutang,Jumlah,Tanggal Hutang,Jatuh Tempo,Status,Keterangan\n"
                + debts.map(debt => 
                    `"${debt.creditorName}","${debt.amount}","${debt.debtDate}","${debt.dueDate || ''}","${debt.status === 'paid' ? 'Lunas' : 'Belum Lunas'}","${debt.description || ''}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `faktubuu_cloud_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSweetAlert('Berhasil', 'Data berhasil diekspor!', 'success');
        }

        function clearAllData() {
            Swal.fire({
                title: 'Hapus Semua Data?',
                text: 'Apakah Anda yakin ingin menghapus SEMUA data? Data di Google Sheets juga akan terhapus!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Hapus Semua!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Konfirmasi Terakhir',
                        text: 'Sekali lagi, yakin ingin menghapus SEMUA data termasuk di Google Sheets?',
                        icon: 'error',
                        showCancelButton: true,
                        confirmButtonColor: '#dc2626',
                        cancelButtonColor: '#6b7280',
                        confirmButtonText: 'HAPUS SEMUA!',
                        cancelButtonText: 'Batal'
                    }).then(async (finalResult) => {
                        if (finalResult.isConfirmed) {
                            creditors = [];
                            debts = [];
                            nextCreditorId = 1;
                            nextDebtId = 1;
                            saveToStorage();
                            renderDebts();
                            updateStatistics();
                            updateReports();
                            updateCreditorsList();
                            
                            // Sync empty data to cloud
                            if (sheetsConfig.isConnected) {
                                await syncNow();
                            }
                            
                            showSweetAlert('Berhasil', 'Semua data berhasil dihapus!', 'success');
                        }
                    });
                }
            });
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        function updateCreditorsList() {
            const datalist = document.getElementById('creditorsList');
            datalist.innerHTML = creditors.map(creditor => 
                `<option value="${creditor.name}">`
            ).join('');
        }

        function saveToStorage() {
            localStorage.setItem('creditors', JSON.stringify(creditors));
            localStorage.setItem('debts', JSON.stringify(debts));
            localStorage.setItem('nextCreditorId', nextCreditorId.toString());
            localStorage.setItem('nextDebtId', nextDebtId.toString());
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97d27ada22ffa8cc',t:'MTc1NzU0NDU4MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
